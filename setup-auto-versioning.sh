#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹
# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ cron-Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AUTO_SCRIPT="$SCRIPT_DIR/auto-versioning.sh"
CRON_LOG="$SCRIPT_DIR/cron-auto-versioning.log"

echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹"
echo "=============================================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
if [ ! -f "$AUTO_SCRIPT" ]; then
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ $AUTO_SCRIPT Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    exit 1
fi

# Ð”ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼
chmod +x "$AUTO_SCRIPT"

echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ´ÐµÐ»Ð°Ð½ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¼"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ cron-Ð·Ð°Ð´Ð°Ñ‡Ñƒ
echo "ðŸ“… Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ cron-Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ..."

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÑƒÑŽ cron-Ð·Ð°Ð´Ð°Ñ‡Ñƒ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
(crontab -l 2>/dev/null | grep -v "auto-versioning.sh") | crontab -

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ cron-Ð·Ð°Ð´Ð°Ñ‡Ñƒ (ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ Ð² 0 Ð¼Ð¸Ð½ÑƒÑ‚)
(crontab -l 2>/dev/null; echo "0 * * * * cd $SCRIPT_DIR && $AUTO_SCRIPT >> $CRON_LOG 2>&1") | crontab -

echo "âœ… Cron-Ð·Ð°Ð´Ð°Ñ‡Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð°: Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ Ð² 0 Ð¼Ð¸Ð½ÑƒÑ‚"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°
cat > "$SCRIPT_DIR/run-auto-versioning.sh" << 'EOF'
#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AUTO_SCRIPT="$SCRIPT_DIR/auto-versioning.sh"

echo "ðŸš€ Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹"
echo "================================================"

if [ -f "$AUTO_SCRIPT" ]; then
    cd "$SCRIPT_DIR"
    "$AUTO_SCRIPT"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ $AUTO_SCRIPT Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
    exit 1
fi
EOF

chmod +x "$SCRIPT_DIR/run-auto-versioning.sh"

echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½: run-auto-versioning.sh"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
cat > "$SCRIPT_DIR/stop-auto-versioning.sh" << 'EOF'
#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹

echo "ðŸ›‘ ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹"
echo "============================================"

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ cron-Ð·Ð°Ð´Ð°Ñ‡Ñƒ
(crontab -l 2>/dev/null | grep -v "auto-versioning.sh") | crontab -

echo "âœ… Cron-Ð·Ð°Ð´Ð°Ñ‡Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°"
echo "â„¹ï¸  ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¹ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾"
EOF

chmod +x "$SCRIPT_DIR/stop-auto-versioning.sh"

echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½: stop-auto-versioning.sh"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð»Ð¾Ð³Ð¾Ð²
cat > "$SCRIPT_DIR/view-auto-logs.sh" << 'EOF'
#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð»Ð¾Ð³Ð¾Ð² Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="$SCRIPT_DIR/auto-versioning.log"
CRON_LOG="$SCRIPT_DIR/cron-auto-versioning.log"

echo "ðŸ“‹ Ð›Ð¾Ð³Ð¸ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹"
echo "======================================="

if [ -f "$LOG_FILE" ]; then
    echo "ðŸ“„ ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³ ($LOG_FILE):"
    echo "----------------------------------------"
    tail -20 "$LOG_FILE"
    echo ""
else
    echo "â„¹ï¸  ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
fi

if [ -f "$CRON_LOG" ]; then
    echo "ðŸ“„ Cron Ð»Ð¾Ð³ ($CRON_LOG):"
    echo "----------------------------------------"
    tail -20 "$CRON_LOG"
else
    echo "â„¹ï¸  Cron Ð»Ð¾Ð³ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
fi
EOF

chmod +x "$SCRIPT_DIR/view-auto-logs.sh"

echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð»Ð¾Ð³Ð¾Ð² ÑÐ¾Ð·Ð´Ð°Ð½: view-auto-logs.sh"

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ cron-Ð·Ð°Ð´Ð°Ñ‡Ð¸
echo ""
echo "ðŸ“‹ Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ cron-Ð·Ð°Ð´Ð°Ñ‡Ð¸:"
crontab -l | grep auto-versioning || echo "â„¹ï¸  Cron-Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"

echo ""
echo "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "  ./run-auto-versioning.sh    - Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ"
echo "  ./stop-auto-versioning.sh   - ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸ÑŽ"
echo "  ./view-auto-logs.sh         - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð»Ð¾Ð³Ð¸"
echo "  crontab -l                  - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ cron-Ð·Ð°Ð´Ð°Ñ‡Ð¸"
echo ""
echo "â° ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÐµÑ€ÑÐ¸Ð¹ Ð±ÑƒÐ´ÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ"
echo "ðŸ“ Ð›Ð¾Ð³Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑŽÑ‚ÑÑ Ð²:"
echo "   - $LOG_FILE (Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð»Ð¾Ð³)"
echo "   - $CRON_LOG (cron Ð»Ð¾Ð³)"
